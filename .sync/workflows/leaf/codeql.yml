# This workflow runs CodeQL against the repository.
#
# Results are uploaded to GitHub Code Scanning.
#
# Note: This workflow only supports Windows as CodeQL CLI has confirmed issues running
#       against edk2-style codebases on Linux (only tested on Ubuntu). Therefore, this
#       workflow is written only for Windows but could easily be adapted to run on Linux
#       in the future if needed (e.g. swap out "windows" with agent OS var value, etc.)
#
# NOTE: This file is automatically synchronized from Mu DevOps. Update the original file there
#       instead of the file in this repo.
#
# - Mu DevOps Repo: https://github.com/microsoft/mu_devops
# - File Sync Settings: https://github.com/microsoft/mu_devops/blob/main/.sync/Files.yml
#
# Copyright (c) Microsoft Corporation.
# SPDX-License-Identifier: BSD-2-Clause-Patent

name: "CodeQL"

on:
  push:
    branches:
      - release/*
  pull_request_target:
    branches:
      - release/*
    paths-ignore:
      - '!**.c'
      - '!**.h'

jobs:
  gather_packages:
    name: Gather Repo Packages
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.generate_matrix.outputs.packages }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '>=3.11'

    - name: Generate Package Matrix
      id: generate_matrix
      shell: python
      run: |
        import os
        import json

        packages = [d for d in os.listdir() if d.strip().lower().endswith('pkg')]

        # Ensure the package can actually be built
        for package in packages:
            if not any(file.endswith('.dsc') for file in os.listdir(package)):
                packages.remove(package)

        with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            print(f'packages={json.dumps(packages)}', file=fh)

  analyze:
    name: Analyze
    runs-on: windows-2022
    needs:
      - gather_packages
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.gather_packages.outputs.packages) }}
        include:
          - archs: IA32,X64
          - tool_chain_tag: VS2022

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '>=3.11'

    - name: Install/Upgrade pip Modules
      run: pip install -r pip-requirements.txt --upgrade

    - name: Setup
      run: stuart_setup -c .pytool/CISettings.py -t DEBUG -a ${{ matrix.archs }} TOOL_CHAIN_TAG=${{ matrix.tool_chain_tag }}

    - name: Get CodeQL CLI Cache Data
      id: cache_key_gen
      shell: python
      run: |
        import os
        import yaml

        codeql_cli_ext_dep_name = 'codeqlcli_windows_ext_dep'
        codeql_plugin_dir = os.path.join(os.environ['GITHUB_WORKSPACE'], '.pytool', 'Plugin', 'CodeQL')
        codeql_plugin_file = os.path.join(codeql_plugin_dir, codeql_cli_ext_dep_name + '.yaml')

        with open (codeql_plugin_file) as pf:
            codeql_cli_ext_dep = yaml.safe_load(pf)

            cache_key_name = codeql_cli_ext_dep['name']
            cache_key_version = codeql_cli_ext_dep['version']
            cache_key = f'{cache_key_name}-{cache_key_version}'

            codeql_plugin_cli_ext_dep_dir = os.path.join(codeql_plugin_dir, codeql_cli_ext_dep['name'].strip() + '_extdep')

            with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
                print(f'codeql_cli_cache_key={cache_key}', file=fh)
                print(f'codeql_cli_ext_dep_dir={codeql_plugin_cli_ext_dep_dir}', file=fh)

    - name: Attempt to Load CodeQL CLI From Cache
      id: codeqlcli_cache
      uses: actions/cache@v3
      with:
        path: ${{ steps.cache_key_gen.outputs.codeql_cli_ext_dep_dir }}
        key: ${{ steps.cache_key_gen.outputs.codeql_cli_cache_key }}

    - name: Update
      run: stuart_update -c .pytool/CISettings.py -t DEBUG -a ${{ matrix.archs }} TOOL_CHAIN_TAG=${{ matrix.tool_chain_tag }}

    - name: Download CodeQL CLI
      if: steps.codeqlcli_cache.outputs.cache-hit != 'true'
      run: stuart_update -c .pytool/CISettings.py -t DEBUG -a ${{ matrix.archs }} TOOL_CHAIN_TAG=${{ matrix.tool_chain_tag }} --codeql

    - name: Remove CI Plugins Irrelevant to CodeQL
      shell: python
      run: |
        import os
        import shutil

        plugins_to_keep = ['CodeQL', 'CompilerPlugin']
        plugin_dir = os.path.join(os.environ['GITHUB_WORKSPACE'], '.pytool', 'Plugin')
        if os.path.isdir(plugin_dir):
            for dir in os.listdir(plugin_dir):
                if dir not in plugins_to_keep:
                    shutil.rmtree(os.path.join(plugin_dir, dir), ignore_errors=True)

    - name: CI Build
      env:
        STUART_CODEQL_PATH: ${{ steps.cache_key_gen.outputs.codeql_cli_ext_dep_dir }}
      run: stuart_ci_build -c .pytool/CISettings.py -t DEBUG -p ${{ matrix.package }} -a ${{ matrix.archs }} TOOL_CHAIN_TAG=${{ matrix.tool_chain_tag }} --codeql

    - name: Prepare Env Data for CodeQL Upload
      id: env_data
      env:
        PACKAGE_NAME: ${{ matrix.package }}
      shell: python
      run: |
        import os

        package = os.environ['PACKAGE_NAME'].strip().lower()
        directory_name = 'codeql-analysis-' + package + '-debug'
        file_name = 'codeql-db-' + package + '-debug-0.sarif'
        sarif_path = os.path.join('Build', directory_name, file_name)

        with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
            print(f'sarif_file_path={sarif_path}', file=fh)

    - name: Upload CodeQL Results (SARIF)
      uses: github/codeql-action/upload-sarif@v2
      with:
        # Path to SARIF file relative to the root of the repository.
        sarif_file: ${{ steps.env_data.outputs.sarif_file_path }}
        # Optional category for the results. Used to differentiate multiple results for one commit.
        # Each package is a separate category.
        category: ${{ matrix.package }}
